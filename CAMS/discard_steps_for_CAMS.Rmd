---
title: "DiscaRd steps for CAMS"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, 
											message = FALSE, cache = FALSE,
											progress = TRUE, verbose = FALSE, comment = F
											, error = FALSE, dev = 'png', dpi = 200)
```

```{r setup, eval = F}

setwd("C:/Users/benjamin.galuardi/Documents/GitHub/discaRd")

library(odbc)
# library(RODBC)
library(dplyr, warn.conflicts = FALSE)
library(dbplyr)
library(ggplot2)
library(rgdal)
library(raster)
library(config)
library(stringr)

dw_apsd <- config::get(value = "apsd", file = "K:/R_DEV/config.yml")

bcon <- dbConnect(odbc::odbc(), 
									DSN = dw_apsd$dsn, 
									UID = dw_apsd$uid, 
									PWD = dw_apsd$pwd)


```

```{r get obs and catch data from oracle}

'%!in%' <- function(x,y)!('%in%'(x,y))

# get catch and matched obs data together

c_o_dat = tbl(bcon, sql("
	with obs as (
select link1
, nespp3
, discard
, NVL(sum(discard)/max(kept_all),0) as dk
, max(kept_all) obs_kall
from maps.BG_OBS_KALL_MOCK
-- where year = 2019
group by link1, nespp3, discard
)

select c.*
, o.nespp3
, o.discard
, o.obs_kall
, o.dk
from apsd.catch_link1_temp c
left join (
 select * from obs where nespp3 = 212 
) o
on o.link1 = c.link1
					")
)

```

```{r subset obs trips for a species}

stat_area_sp = tbl(bcon, sql('select * from apsd.stat_areas_def')) %>% 
	filter(nespp3 == '212') %>% 
	dplyr::select(stat_area) %>% 
	distinct() %>% 
	collect()

odat = c_o_dat %>% 
	filter(!is.na(LINK1) & NESPP3 == '212' & AREA %in% local(stat_area_sp[["stat_area"]])) %>% 
	group_by(YEAR, GEARCODE) %>% 
	summarise(dk_gear = sum(DISCARD, na.rm = T)/sum(OBS_KALL, na.rm = T))
	


```


```{r munge?}
cdat %>% 
	mutate(MESHGROUP = case_when(NEGEAR %in% c('054','057') ~ 'lg'
														)
				 , GEARTYPE = case_when( GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Other'
				 					              , NESPP3 == 800 & GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Scallop Dredge')
				 ) %>%
	filter(NESPP3 == 800) %>% 
	group_by(GEARTYPE, MESHGROUP) %>% 
	summarise(psum = sum(POUNDS, na.rm = T))

# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Scallop Dredge'
# WHERE a.nespp3 = '800' 
# AND a.geartype = 'Unknown'
# AND a.gearcode IS NULL	
# /
# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Other'
# WHERE a.geartype = 'Unknown'
# AND a.gearcode IS NULL	

```

