---
title: "DiscaRd steps for CAMS"
output: html_document
editor_options: 
  chunk_output_type: console
---

Discard Rate Current Method Summary

1) Rates determine by observer reported values (gear, area, etc)
2) Incomplete observed trips have missing 'hauls' prorated by observed information from that trip
3) Trips with observer get reported/calculated observed discards   of that specific trip
4) Unobserved trips get discards from the rate calculated from 1)
5) QM is only interested in the summary total of discards for each trip, not subtrips. Often the interested number is a summary of trips, ie. the herring total of bycatch for an area/season or a sector's season's total of GB Cod.

6) Other others are driven by regs. Here I would place transition rates and EM methods.

I recommend separating out issues such as mismatching gear and area for the future QA data system. 

And of course, any change management must be worked through proper and transparent interaction with all end users and clients including council and  SFD.


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, 
											message = FALSE, cache = FALSE,
											progress = TRUE, verbose = FALSE, comment = F
											, error = FALSE, dev = 'png', dpi = 200)
```

```{r setup, eval = F}

setwd("C:/Users/benjamin.galuardi/Documents/GitHub/discaRd")

library(odbc)
# library(RODBC)
library(dplyr, warn.conflicts = FALSE)
library(dbplyr)
library(ggplot2)
library(rgdal)
library(raster)
library(config)
library(stringr)
library(discaRd)

dw_apsd <- config::get(value = "apsd", file = "K:/R_DEV/config.yml")

bcon <- dbConnect(odbc::odbc(), 
									DSN = dw_apsd$dsn, 
									UID = dw_apsd$uid, 
									PWD = dw_apsd$pwd)


```

```{r get obs and catch data from oracle}

'%!in%' <- function(x,y)!('%in%'(x,y))

# get catch and matched obs data together

c_o_dat = tbl(bcon, sql('select * from apsd.bg_obs_cams_tmp1')) 

# %>% 
# 	collect()

# catch only

dat = tbl(bcon, sql('select * from bg_cams_catch_mock'))

# %>% 
# 	collect()

# Stat areas table

stat_area_sp = tbl(bcon, sql('select * from apsd.stat_areas_def'))



#-----------------------------------------------------------#
# Old shit
# 
# c_o_dat = tbl(bcon, sql("
# 	with obs as (
# select link1
# , nespp3
# , discard
# , NVL(sum(discard)/max(kept_all),0) as dk
# , max(kept_all) obs_kall
# from maps.BG_OBS_KALL_MOCK
# -- where year = 2019
# group by link1, nespp3, discard
# )
# 
# select c.*
# , o.nespp3
# , o.discard
# , o.obs_kall
# , o.dk
# from apsd.catch_link1_temp c
# left join (
#  select * from obs where nespp3 = 212 
# ) o
# on o.link1 = c.link1
# 					")
# )
# 
# 
# odat2 = tbl(bcon, sql('
# 							with obs as (
# 							 select o.*
# 							, SUM(case when catdisp = 0 then o.hailwt else 0 end) OVER(PARTITION BY o.link3) as discard
# 							, SUM(o.hailwt) OVER(PARTITION BY o.link3) as obs_kall
# 							, substr(nespp4, 1, 3) as NESPP3
# 							from (
# 							 select * from apsd.BG_OBDBS_TABLES_5_2018
# 							 union all
# 							 select * from apsd.BG_OBDBS_TABLES_5_2019
# 							)
# 							 o
# 							)
# 					select c.*
# 						, o.*
# 						from apsd.catch_link1_temp c
# 						left join (
# 						 select * from obs where nespp3 = 212 
# 						) o
# 						on o.link1 = c.link1		
# 							
# 							'
# 							)) %>% 
# 	   dplyr::select(YEAR, LINK1, LINK3, AREA, DATELAND, DATESAIL, FISHDISP, CATDISP, GEARCAT, HAILWT, LIVEWT, OBS_KALL, DISCARD, NESPP4, NESPP3, NEGEAR,MESHSIZE, MESHGROUP, GEARTYPE, ACCESSAREA, VMSCODE) 
# 
# 


```

```{r subset obs trips for a species}
# 
# stat_area_sp = tbl(bcon, sql('select * from apsd.stat_areas_def')) %>% 
# 	filter(NESPP3 == '212') %>% 
# 	dplyr::select(STAT_AREA) %>% 
# 	distinct() %>% 
# 	collect()

# odat = c_o_dat %>% 
# 	filter(!is.na(LINK1) & NESPP3 == '212' & AREA %in% local(stat_area_sp[["stat_area"]])) %>% 
# 	group_by(YEAR, GEARCODE) %>% 
# 	summarise(dk_gear = sum(DISCARD, na.rm = T)/sum(OBS_KALL, na.rm = T))


# tbl(bcon, sql('select * from obdbs.OBMSZ@nova where year = 2019 and program <> 000')	)
# 
# tbl(bcon, sql('SELECT link1, link3, program, year, negear, codmsize, linermsize FROM obdbs.obotgh@nova where year = 2019 and program <> 000'))

	


# -------------------------------------------

dk_gear_mesh <- c_o_dat %>% 
	# filter(!is.na(LINK1) & NESPP3 == 801 & AREA %in% local(stat_area_sp[["STAT_AREA"]]) ) %>%
	filter(!is.na(LINK1) & NESPP3 == 801)  %>%   #& AREA %in% stat_area_sp$STAT_AREA)
	group_by(YEAR, OBS_GEAR, OBS_MESHGROUP) %>% 
	summarise(dk_gear = sum(DISCARD, na.rm = T)/sum(OBS_HAUL_KEPT, na.rm = T)
						, OBS_KALL = sum(OBS_HAUL_KEPT, na.rm = T)
						) %>% 
	collect()

# SQUID EXAMPLE
# pull table as is for a species
# this can be used to assign discard directly to subtrip

bdat <- c_o_dat %>% 
	filter(!is.na(LINK1) & NESPP3 == 801) %>% 
	# mutate(SEADAYS = 0
	# 			 , DISCARD = sum(DISCARD, na.rm = T)
	# 			 , KALL = sum(OBS_HAUL_KEPT, na.rm = T)
	# 			 ) %>% 
	collect()

# Use this to park discard into subtrips..
obs_discard = bdat %>% 
	group_by(LINK1, OBS_GEAR, OBS_MESHGROUP) %>% 
	summarise(KALL = sum(CAMS_KALL), DISCARD = sum(DISCARD), dk = sum(DISCARD, na.rm = T)/sum(CAMS_KALL, na.rm = T))
	
# Make an assumed rate by gear/mesh

assumed_discard = bdat %>% 
	dplyr::group_by(OBS_GEAR, OBS_MESHGROUP) %>% 
	dplyr::summarise(KALL = sum(CAMS_KALL), DISCARD = sum(DISCARD), dk = sum(DISCARD, na.rm = T)/sum(CAMS_KALL, na.rm = T))
	
# set up bdat for discaRd: rolled up by sub-trip
bdat_focal <- bdat %>% 
	filter(YEAR == 2019) %>% 
	mutate(STRATA = paste(OBS_GEAR, OBS_MESHGROUP, sep = '_')) %>% 
  dplyr::group_by(DMIS_TRIP_ID, OBS_GEAR, OBS_MESHGROUP, AREA, STRATA) %>% 
  dplyr::summarise(KALL = sum(CAMS_KALL), BYCATCH = sum(DISCARD))

#---------------------------------------------------------------------------------------#
# trips data: rolled up by sub-trip
# This could be a generic table of KALL by subtrip..
#---------------------------------------------------------------------------------------#


#---------------------------------------------------------------------------------------#
# Here is where various stratification would make sense
#---------------------------------------------------------------------------------------#

ddat_focal <- dat %>% 
		filter(YEAR == 2019) %>% 
	  collect() %>% 
		mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_')) %>% 
		# collect() %>% 
		# group_by(DMIS_TRIP_ID) %>%
		dplyr::group_by(DMIS_TRIP_ID, YEAR, GEARNM, GEARCODE, NEGEAR, MESHGROUP, CAREA, STRATA) %>% 
		dplyr::summarise(LIVE_POUNDS = sum(LIVE_POUNDS, na.rm = T))

	
ddat_focal = ddat_focal %>% 
	ungroup() %>% 
	mutate(DOCID = DMIS_TRIP_ID)

	
# Get complete strata
strata_complete = unique(c(bdat_focal$STRATA, ddat_focal$STRATA))

allest = get.cochran.ss.by.strat(bydat = bdat_focal, trips = ddat_focal, strata_name = 'STRATA', targCV = .3, strata_complete = strata_complete)		

# discard rates by strata
dest_strata = allest$C %>% summarise(STRATA = STRATA
                       , N = N
                       , n = n
                       , orate = round(n/N, 2)
                       , drate = RE_mean
                       , KALL = K, disc_est = round(D)
                       , CV = round(RE_rse, 2)
										)

# plug in estimated rates to the unobserved
ddat_rate = ddat_focal
ddat_rate$DISC_RATE = dest_strata$drate[match(ddat_rate$STRATA, dest_strata$STRATA)]	

# substitute assumed rate where we can
assumed_discard = assumed_discard %>% 
	mutate(STRATA = paste(OBS_GEAR, OBS_MESHGROUP, sep = '_'))

ddat_rate = ddat_rate %>% 
	mutate(STRATA_ASSUMED = paste(NEGEAR, MESHGROUP, sep = '_')) %>% 
	mutate(ARATE_IDX = match(STRATA_ASSUMED, assumed_discard$STRATA)) 

# ddat_rate$ARATE_IDX[is.na(ddat_rate$ARATE_IDX)] = 0
ddat_rate$ARATE = assumed_discard$dk[ddat_rate$ARATE_IDX]

# %>% 
# 	mutate(ARATE = assumed_discard[ARATE_IDX])


# ddat_rate <- 
	ddat_rate %>% 
	mutate(DISC_RATE = case_when((is.na(DISC_RATE) & !is.na(ARATE_IDX)) ~ assumed_discard$dk[ARATE_IDX]
															 , DISC_RATE))

	
```

```{r load master gear table if needed}

# need to add gear here

# mgear = readxl::read_xlsx('C:/Users/benjamin.galuardi/Documents/GitHub/discaRd/CAMS/GAR master gear codes.xlsx')

mgear = tbl(bcon, sql('select * from apsd.master_gear'))

mgear = mgear %>% 
	group_by(VTR_GEAR_CODE) %>% 
	distinct(NEGEAR, VTR_GEAR_CODE) %>% 
  ungroup() %>% 
	collect()


```


```{r munge?}
cdat %>% 
	mutate(MESHGROUP = case_when(NEGEAR %in% c('054','057') ~ 'lg'
														)
				 , GEARTYPE = case_when( GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Other'
				 					              , NESPP3 == 800 & GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Scallop Dredge')
				 ) %>%
	filter(NESPP3 == 800) %>% 
	group_by(GEARTYPE, MESHGROUP) %>% 
	summarise(psum = sum(POUNDS, na.rm = T))

# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Scallop Dredge'
# WHERE a.nespp3 = '800' 
# AND a.geartype = 'Unknown'
# AND a.gearcode IS NULL	
# /
# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Other'
# WHERE a.geartype = 'Unknown'
# AND a.gearcode IS NULL	

```

