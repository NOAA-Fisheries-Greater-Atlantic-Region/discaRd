---
title: "DiscaRd steps for CAMS"
output: html_document
editor_options: 
  chunk_output_type: console
---

Discard Rate Current Method Summary

1) Rates determine by observer reported values (gear, area, etc)
2) Incomplete observed trips have missing 'hauls' prorated by observed information from that trip
3) Trips with observer get reported/calculated observed discards   of that specific trip
4) Unobserved trips get discards from the rate calculated from 1)
5) QM is only interested in the summary total of discards for each trip, not subtrips. Often the interested number is a summary of trips, ie. the herring total of bycatch for an area/season or a sector's season's total of GB Cod.

6) Other others are driven by regs. Here I would place transition rates and EM methods.

I recommend separating out issues such as mismatching gear and area for the future QA data system. 

And of course, any change management must be worked through proper and transparent interaction with all end users and clients including council and  SFD.


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, 
											message = FALSE, cache = FALSE,
											progress = TRUE, verbose = FALSE, comment = F
											, error = FALSE, dev = 'png', dpi = 200)
```

```{r setup, eval = T}

setwd("C:/Users/benjamin.galuardi/Documents/GitHub/discaRd/CAMS/")

library(odbc)
# library(RODBC)
library(dplyr, warn.conflicts = FALSE)
library(dbplyr)
library(ggplot2)
library(rgdal)
library(raster)
library(config)
library(stringr)
library(discaRd)

dw_apsd <- config::get(value = "apsd", file = "K:/R_DEV/config.yml")

bcon <- dbConnect(odbc::odbc(), 
									DSN = dw_apsd$dsn, 
									UID = dw_apsd$uid, 
									PWD = dw_apsd$pwd)


```

```{r get obs and catch data from oracle}

'%!in%' <- function(x,y)!('%in%'(x,y))

# get catch and matched obs data together

# c_o_dat = tbl(bcon, sql('select * from apsd.bg_obs_cams_tmp1')) 


# get another version that rolls up by trip..

# apsd.bg_obs_cams_tmp1 has only trips with multiple subtrips
# apsd.bg_obs_cams_tmp2 has all trips.. 

c_o_dat2 <- tbl(bcon, sql('
	select year
	, area
	, vtrserno
	, docid
	, dmis_trip_id
	, nespp3
	, NEGEAR
	, GEARTYPE
	, MESHGROUP
	, NVL(sum(discard),0) as discard
	, NVL(round(max(subtrip_kall)),0) as subtrip_kall
	, NVL(round(max(obs_kall)),0) as obs_kall
	, NVL(sum(discard)/round(max(obs_kall)), 0) as dk
	from apsd.bg_obs_cams_tmp2
	where nespp3 is not null
	group by year, area, vtrserno, nespp3, docid, NEGEAR, GEARTYPE
	, MESHGROUP, dmis_trip_id
	order by vtrserno desc
')) %>% 
	collect()

# obs only 

obs = tbl(bcon, sql('select * from obs_cams_prorate'))



# catch only

# dat = tbl(bcon, sql('select * from bg_cams_catch_mock'))


dat = tbl(bcon, sql('
select DMIS_TRIP_ID
, VTRSERNO
, YEAR
, GEARNM
, GEARCODE
, GEARTYPE
, NEGEAR
, MESHGROUP
, CAREA
, sum(pounds) as live_Pounds
from bg_cams_catch_mock
group by DMIS_TRIP_ID, VTRSERNO, YEAR, GEARNM, GEARCODE, NEGEAR, GEARTYPE, MESHGROUP, CAREA
'))

# %>% 
# 	collect()

# Stat areas table

stat_area_sp = tbl(bcon, sql('select * from apsd.stat_areas_def'))



```

```{r subset obs trips for a species of squid}

# SQUID EXAMPLE
# pull table as is for a species
# this can be used to assign discard directly to subtrip

bdat <- c_o_dat2 %>% 
	# group_by(DMIS_TRIP_ID, NESPP3) %>% 
	mutate(SPECIES_DISCARD = case_when(NESPP3 == '802' ~ DISCARD)) %>% 
	mutate(SPECIES_DISCARD = replace_na(SPECIES_DISCARD, 0))
	# filter(NESPP3 == 802) %>% 
	# mutate(SEADAYS = 0
	# 			 , DISCARD = sum(DISCARD, na.rm = T)
	# 			 , KALL = sum(OBS_HAUL_KEPT, na.rm = T)
	# 			 ) %>% 
	# collect()

bdat$MESHGROUP[bdat$MESHGROUP == 'na'] = NA


# Use this to park discard into subtrips..
obs_discard = bdat %>% 
	group_by(YEAR
					 , VTRSERNO
					 # , NEGEAR
					 , GEARTYPE
					 , MESHGROUP
					 ) %>% 
	dplyr::summarise(KALL = sum(SUBTRIP_KALL), DISCARD = sum(SPECIES_DISCARD), dk = sum(SPECIES_DISCARD, na.rm = T)/sum(SUBTRIP_KALL, na.rm = T))
	
# Make an assumed rate by gear/mesh

assumed_discard = bdat %>% 
	filter(YEAR == 2019) %>% 
	dplyr::group_by(YEAR
									# , NEGEAR
									, GEARTYPE
									, MESHGROUP) %>% 
	dplyr::summarise(KALL = sum(SUBTRIP_KALL), DISCARD = sum(SPECIES_DISCARD), dk = sum(SPECIES_DISCARD, na.rm = T)/sum(SUBTRIP_KALL, na.rm = T))
	
# set up bdat for discaRd: rolled up by sub-trip
# may need to change this to OBS table explicitly!!!! just like everything else... 
bdat_focal <- bdat %>% 
	filter(YEAR == 2019) %>% 
	# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_')) %>% 
	mutate(STRATA = paste(GEARTYPE, MESHGROUP, sep = '_')) %>% 
  dplyr::group_by(DMIS_TRIP_ID
  								# , NEGEAR
  								, GEARTYPE
  								, MESHGROUP
  								, STRATA
  								) %>% 
  dplyr::summarise(KALL = sum(SUBTRIP_KALL), BYCATCH = sum(SPECIES_DISCARD))

#---------------------------------------------------------------------------------------#
# trips data: rolled up by sub-trip
# This could be a generic table of KALL by subtrip..
#---------------------------------------------------------------------------------------#


#---------------------------------------------------------------------------------------#
# Here is where various stratification would make sense
#---------------------------------------------------------------------------------------#

ddat_focal <- dat %>% 
		filter(YEAR == 2019) %>% 
	  collect() %>% 
	  mutate(STRATA = paste(GEARTYPE, MESHGROUP, sep = '_'))
		# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_')) #%>% 
		# collect() %>% 
		# group_by(DMIS_TRIP_ID) %>%
		# dplyr::group_by(DMIS_TRIP_ID, YEAR, GEARNM, GEARCODE, NEGEAR, MESHGROUP, CAREA, STRATA) %>% 
		# dplyr::summarise(LIVE_POUNDS = sum(LIVE_POUNDS, na.rm = T))

	
ddat_focal = ddat_focal %>%
ungroup() %>%
mutate(DOCID = DMIS_TRIP_ID) # DOCID is hard coded in discaRd.. in this case, CV is calculated using  N = subtrips

	
# Get complete strata
strata_complete = unique(c(bdat_focal$STRATA, ddat_focal$STRATA))

allest = get.cochran.ss.by.strat(bydat = bdat_focal, trips = ddat_focal, strata_name = 'STRATA', targCV = .3, strata_complete = strata_complete)		

# discard rates by strata
dest_strata = allest$C %>% summarise(STRATA = STRATA
                       , N = N
                       , n = n
                       , orate = round(n/N, 2)
                       , drate = RE_mean
                       , KALL = K, disc_est = round(D)
                       , CV = round(RE_rse, 2)
										)

# plug in estimated rates to the unobserved
ddat_rate = ddat_focal
ddat_rate$DISC_RATE = dest_strata$drate[match(ddat_rate$STRATA, dest_strata$STRATA)]	
ddat_rate$CV = dest_strata$CV[match(ddat_rate$STRATA, dest_strata$STRATA)]	


# substitute assumed rate where we can
assumed_discard = assumed_discard %>% 
	mutate(STRATA = paste(GEARTYPE, MESHGROUP, sep = '_'))
# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_'))

ddat_rate = ddat_rate %>% 
	mutate(STRATA_ASSUMED = paste(GEARTYPE, MESHGROUP, sep = '_')) %>% 
	# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_'))
	mutate(ARATE_IDX = match(STRATA_ASSUMED, assumed_discard$STRATA)) 

# ddat_rate$ARATE_IDX[is.na(ddat_rate$ARATE_IDX)] = 0
ddat_rate$ARATE = assumed_discard$dk[ddat_rate$ARATE_IDX]


# incorporate teh assumed rate into the calculated discard rates
ddat_rate <- ddat_rate %>% 
	mutate(CRATE = coalesce(DISC_RATE, ARATE)) %>%
	mutate(CRATE = replace_na(CRATE, 0)) 


# merge observed discards with estimated discards
# Use the observer tables created, NOT the merged trips/obs table.. 
# match on VTRSERNO? 

out_tab = obs_discard %>% 
	ungroup() %>% 
	dplyr::select(VTRSERNO, DISCARD) %>% 
	right_join(x = ., y = ddat_rate, by = 'VTRSERNO') %>% 
  mutate(EST_DISCARD = CRATE*LIVE_POUNDS) %>% 
	mutate(DISCARD = if_else(!is.na(DISCARD), DISCARD, EST_DISCARD)
				 ) 

# check how much discard is observed directly vs. estimated
out_tab %>%
	dplyr::summarise(d = sum(DISCARD, na.rm = T)
						,est_d = sum(EST_DISCARD, na.rm = T)
						, OBS_DISCARD = sum(DISCARD, na.rm = T) - sum(EST_DISCARD, na.rm = T)) %>% 
		knitr::kable(format = 'markdown', col.names = c('Total Discard','Portion that was Estimated','Portion that was assigned'))

# compare to obs_discard standalone table
obs_discard %>% 
	filter(YEAR == 2019) %>% 
	ungroup() %>% 
	dplyr::select(DISCARD) %>% 
	sum() %>% 
	knitr::kable(format = 'markdown', col.names = 'Observed Discard from OBS table')




```

## Squid Example

**NOTES:**

The discard estimation runs normally using `discaRd`. 

The stratification scheme for this example was simplified to use only gear and mesh. 

For Quota Monitoring ACL accounting, region (North/south), time of year, and (usually) different scallop trip types are designated. 

Observed Discard is not typically assigned.. 

I seem to be getting much lower trip and obs trip counts than what exists in the ACL annual reports. This may be due to the apportionment processing.. 

I am using subtrip as the `N` unit. 

the total number of observed trips is comparable in the newly created tables but something is getting lost on the import step.. 
ACL report: 4299
total from new table: 4210
total in imported table 4000
total from `discaRd` is `r  dest_strata$n %>% sum()`

hard match on `LINK1, NEGEAR, MESHGROUP, CAREA` is causing some obs trips to drop.. Example: scallop dredge has a total of 562 observed trips in the 2019 final ACL accounting but here there are only 515. I think this is likely due to CAREA more than anything. 

```{r print some summary tables}

assumed_discard %>% knitr::kable(caption = 'Assumed discard. This could be a generalized rate from current year. This could also be built from previous years discard info.')

dest_strata %>% knitr::kable(caption = 'Stratified Estimate From discaRd')

# out_tab %>% head() %>% 
	# knitr::kable(format= 'markdown', caption = "Exampe of tabular output")

```

### example of output table

This can be modified to perhaps save only the `dmis_trip_id`, `strata`, and `discard estimate`. 

```{r example of output table}
out_tab %>% 
	head() %>% 
	DT::datatable(., filter = "top")

```

```{r do a few species}
make_bdat_cams <- function(input_table = c_o_dat2, species_nespp3 = '802') {
	
	bdat <- input_table %>% 
	# group_by(DMIS_TRIP_ID, NESPP3) %>% 
	mutate(SPECIES_DISCARD = case_when(NESPP3 == species_nespp3 ~ DISCARD)) %>% 
	mutate(SPECIES_DISCARD = replace_na(SPECIES_DISCARD, 0))


 bdat$MESHGROUP[bdat$MESHGROUP == 'na'] = NA

 bdat
 
 }

# Use this to park discard into subtrips..
get_obs_disc_vals <- function(bdat){

obs_discard = bdat %>% 
	group_by(YEAR
					 , VTRSERNO
					 # , NEGEAR
					 , GEARTYPE
					 , MESHGROUP
					 ) %>% 
	dplyr::summarise(KALL = sum(SUBTRIP_KALL), DISCARD = sum(SPECIES_DISCARD), dk = sum(SPECIES_DISCARD, na.rm = T)/sum(SUBTRIP_KALL, na.rm = T))

obs_discard
	
}

# Make an assumed rate by gear/mesh

make_assumed_rate <- function(bdat, year = 2019){
 assumed_discard = bdat %>% 
	filter(YEAR == year) %>% 
	dplyr::group_by(YEAR
									# , NEGEAR
									, GEARTYPE
									, MESHGROUP) %>% 
	dplyr::summarise(KALL = sum(SUBTRIP_KALL), DISCARD = sum(SPECIES_DISCARD), dk = sum(SPECIES_DISCARD, na.rm = T)/sum(SUBTRIP_KALL, na.rm = T))
 
 assumed_discard

}	

# set up bdat for discaRd: rolled up by sub-trip
# may need to change this to OBS table explicitly!!!! just like everything else... 

make_bdat_focal <- function(bdat, year = 2019){ #, strata = paste(GEARTYPE, MESHGROUP, AREA, sep = '_')
bdat_focal <- bdat %>% 
	filter(YEAR == year) %>% 
	mutate(STRATA = paste(NEGEAR, MESHGROUP, AREA, sep = '_')) %>%
	# mutate(STRATA = strata) %>% 
  dplyr::group_by(DMIS_TRIP_ID
  								# , NEGEAR
  								# , GEARTYPE
  								# , MESHGROUP
  								, STRATA
  								) %>% 
  dplyr::summarise(KALL = sum(SUBTRIP_KALL), BYCATCH = sum(SPECIES_DISCARD))

bdat_focal
}


ddat_focal <- ddat_focal %>% 
	  mutate(STRATA = paste(GEARTYPE, MESHGROUP, CAREA, sep = '_'))

run_discard <- function(obstab, ddat, year = 2019, species_nespp3 = '802'){ #, strata = paste(GEARTYPE, MESHGROUP, AREA, sep = '_')
	bdat = make_bdat_cams(obstab, species_nespp3 = species_nespp3)
	bdat_focal = make_bdat_focal(bdat)
	obs_discard = get_obs_disc_vals(bdat)
	assumed_rate = make_assumed_rate(bdat, year = year)
	
	# Get complete strata
strata_complete = unique(c(bdat_focal$STRATA, ddat_focal$STRATA))

allest = get.cochran.ss.by.strat(bydat = bdat_focal, trips = ddat_focal, strata_name = 'STRATA', targCV = .3, strata_complete = strata_complete)		

# discard rates by strata
dest_strata = allest$C %>% summarise(STRATA = STRATA
                       , N = N
                       , n = n
                       , orate = round(n/N, 2)
                       , drate = RE_mean
                       , KALL = K, disc_est = round(D)
                       , CV = round(RE_rse, 2)
										)

# plug in estimated rates to the unobserved
ddat_rate = ddat_focal
ddat_rate$DISC_RATE = dest_strata$drate[match(ddat_rate$STRATA, dest_strata$STRATA)]	
ddat_rate$CV = dest_strata$CV[match(ddat_rate$STRATA, dest_strata$STRATA)]	


# substitute assumed rate where we can
assumed_discard = assumed_discard %>% 
	mutate(STRATA = paste(GEARTYPE, MESHGROUP, sep = '_'))
# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_'))

ddat_rate = ddat_rate %>% 
	mutate(STRATA_ASSUMED = paste(GEARTYPE, MESHGROUP, sep = '_')) %>% 
	# mutate(STRATA = paste(NEGEAR, MESHGROUP, sep = '_'))
	mutate(ARATE_IDX = match(STRATA_ASSUMED, assumed_discard$STRATA)) 

# ddat_rate$ARATE_IDX[is.na(ddat_rate$ARATE_IDX)] = 0
ddat_rate$ARATE = assumed_discard$dk[ddat_rate$ARATE_IDX]


# incorporate teh assumed rate into the calculated discard rates
ddat_rate <- ddat_rate %>% 
	mutate(CRATE = coalesce(DISC_RATE, ARATE)) %>%
	mutate(CRATE = replace_na(CRATE, 0)) 


# merge observed discards with estimated discards
# Use the observer tables created, NOT the merged trips/obs table.. 
# match on VTRSERNO? 

out_tab = obs_discard %>% 
	ungroup() %>% 
	dplyr::select(VTRSERNO, DISCARD) %>% 
	right_join(x = ., y = ddat_rate, by = 'VTRSERNO') %>% 
  mutate(EST_DISCARD = CRATE*LIVE_POUNDS) %>% 
	mutate(DISCARD = if_else(!is.na(DISCARD), DISCARD, EST_DISCARD)
				 ) 

list(species = species_nespp3
		 , allest = allest
		 , res = out_tab
 )
	
}

# ddat_focal is run by itself since it takes a longtime.. and can be repeated

run_discard(obstab = c_o_dat2, ddat = ddat_focal, year = 2019, species_nespp3 = '802')


spec_list = c('801','802','212','800','125')

out_list = list()

ii = 1

for(i in spec_list){
	print(paste0('Estimating discaRd for NESPP3 ', i))
	out_list[[ii]] = run_discard(obstab = c_o_dat2, ddat = ddat_focal, year = 2019, species_nespp3 = i)
	out_list[[ii]]$res$NESPP3 = i
	ii = ii+1
	
}

names(out_list) = spec_list


# pull out list parts and rearrange

out_res = out_list[[1]]$res %>% 
	dplyr::select(DMIS_TRIP_ID, NESPP3 , DISCARD)

for(i in 2:length(out_list)){
	tmp = out_list[[i]]$res %>% 
		dplyr::select(DMIS_TRIP_ID, NESPP3 , DISCARD)
	
	out_res = rbind(out_res, tmp)
	
}


out_res %>% 
	group_by(NESPP3) %>% 
	dplyr::summarise(sum(DISCARD, na.rm = T))

```




```{r load master gear table if needed, eval = F}

# need to add gear here

# mgear = readxl::read_xlsx('C:/Users/benjamin.galuardi/Documents/GitHub/discaRd/CAMS/GAR master gear codes.xlsx')

mgear = tbl(bcon, sql('select * from apsd.master_gear'))

mgear = mgear %>% 
	group_by(VTR_GEAR_CODE) %>% 
	distinct(NEGEAR, VTR_GEAR_CODE) %>% 
  ungroup() %>% 
	collect()


```


```{r munge?, eval = F}
cdat %>% 
	mutate(MESHGROUP = case_when(NEGEAR %in% c('054','057') ~ 'lg'
														)
				 , GEARTYPE = case_when( GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Other'
				 					              , NESPP3 == 800 & GEARTYPE == 'Unknown' & is.na(GEARTYPE) ~ 'Scallop Dredge')
				 ) %>%
	filter(NESPP3 == 800) %>% 
	group_by(GEARTYPE, MESHGROUP) %>% 
	summarise(psum = sum(POUNDS, na.rm = T))

# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Scallop Dredge'
# WHERE a.nespp3 = '800' 
# AND a.geartype = 'Unknown'
# AND a.gearcode IS NULL	
# /
# UPDATE bg_total_landings_1 a
# SET a.geartype = 'Other'
# WHERE a.geartype = 'Unknown'
# AND a.gearcode IS NULL	

```

